<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Koodiklinikan NHL Bracket</title>

  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      text-align: left;
    }

    #last-updated {
      margin-top: 1em;
      font-style: italic;
    }

    tbody > tr:nth-child(2n) {
      background: #f5f5f5
    }

    img {
      max-width: 40px;
    }

    td.correct {
      background: green
    }

    td.incorrect {
      background: rgb(106, 3, 3);
    }

    td {
      width: 7%;
    }

    td.wide {
      width: 15%;
    }

    td.narrow {
      width: 5%
    }

    td.logo {
      text-align: center;
    }

    div.series {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    span {
      color: rgb(199, 199, 199);
    }

    span.correct-games {
      font-weight: 900;
      color: white
    }
  </style>
</head>
<body>
  <h1>Koodiklinikan NHL Bracket Leaderboard 2023</h1>
  <p>Saa parannella: <a href="https://github.com/Hamatti/kk-bracket">hamatti/kk-bracket</a></p>

  <table>
    <thead>
      <tr>
        <th>Sijoitus</th>
        <th>Nimi</th>
        <th>Mestarivalinta</th>
        <th>Pisteitä</th>
        <th>Mahdolliset maksimipisteet</th>
        <th>
          <div class="series">
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/21.svg" alt="Colorado Avalance">
            -
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/55.svg" alt="Seattle Kraken">
          </div>
        </th>
        <th>
          <div class="series">
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/25.svg" alt="Dallas Stars">
            -
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/30.svg" alt="Minnesota Wild">
          </div>
        </th>
        <th>
          <div class="series">
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/54.svg" alt="Vegas Golden Knights">
            -
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/52.svg" alt="Winnipeg Jets">
          </div>
        </th>
        <th>
          <div class="series">
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/22.svg" alt="Edmonton Oilers">
            -
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/26.svg" alt="Los Angeles Kings">
          </div>
        </th>
        <th>
          <div class="series">
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/6.svg" alt="Boston Bruins">
            -
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/13.svg" alt="Florida Panthers">
          </div>
        </th>
        <th>
          <div class="series">
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-light/10.svg" alt="Toronto Maple Leafs">
            -
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-light/14.svg" alt="Tampa Bay Lightning">
          </div>
        </th>
        <th>
          <div class="series">
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/12.svg" alt="Carolina Hurricanes">
            -
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/2.svg" alt="New York Islanders">
          </div>
        </th>
        <th>
          <div class="series">
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/1.svg" alt="New Jersey Devils">
            -
            <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/3.svg" alt="New York Rangers">
          </div>
        </th>
        
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="last-updated"></div>
  
  <script>
    const tbody = document.querySelector('tbody')
    let lastUpdated = null;
    fetch('https://low6-nhl-brackets-prod.azurewebsites.net/leagues/19816/leaderboard?offset=0&limit=17')
      .then(res => res.json())
      .then(async ({entries}) => {
        const series = await fetch('https://low6-nhl-brackets-prod.azurewebsites.net/game').then(res => res.json());
        const games = series.game.series_results;
        const teams = series.game.teams;

        const firstRound = [101, 102, 103, 104, 105, 106, 107, 108];
        entries.forEach(entry => {
          let tr = document.createElement('tr');
          const {
            rank,
            entry_name,
            points,
            possible_points,
            updated_at,
            champion_id
          } = entry

          let rankTd = document.createElement('td')
          rankTd.innerHTML = rank;
          let nameTd = document.createElement('td')
          nameTd.innerHTML = entry_name;
          nameTd.classList.add('wide')
          let pointsTd = document.createElement('td')
          pointsTd.innerHTML = points;
          let possiblePointsTd = document.createElement('td')
          possiblePointsTd.innerHTML = possible_points;
          let championTd = document.createElement('td')
          let championlogo = document.createElement('img')
          championlogo.src = `https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/${champion_id}.svg`;
          championlogo.alt = teams.find(team => team.team_id === parseInt(champion_id)).display_name
          championTd.appendChild(championlogo)
          championTd.classList.add('narrow')
          championTd.classList.add('logo')

          tr.appendChild(rankTd)
          tr.appendChild(nameTd)
          tr.appendChild(championTd)
          tr.appendChild(pointsTd)
          tr.appendChild(possiblePointsTd)

          firstRound.forEach(gameId => {
            pick_key = `match_${gameId}_pick`;
            let gameTd = document.createElement('td');
            gameTd.classList.add('narrow')
            gameTd.classList.add('logo')

            let pickSVG = document.createElement('img')

            const currentSeries = games.find(game => game.id === gameId)
            const winnerId = currentSeries.winner_id

            // Some logos look better with primary light
            if(entry[pick_key] === '14' || entry[pick_key] === '10') {
              pickSVG.src = `https://www-league.nhlstatic.com/images/logos/teams-current-primary-light/${entry[pick_key]}.svg`
            } else {
              pickSVG.src = `https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/${entry[pick_key]}.svg`
            }
            gameTd.appendChild(pickSVG)

            teamName = teams.find(team => team.team_id === parseInt(entry[pick_key])).display_name
            pickSVG.alt = teamName

            if(winnerId !== null) {
              const t1_wins = parseInt(currentSeries.team_1_wins);
              const t2_wins = parseInt(currentSeries.team_2_wins);
              const seriesLength = t1_wins + t2_wins
              const howManyGames = entry[`match_${gameId}_match_played`]
              const span = document.createElement('span')
              span.textContent = `(in ${howManyGames})`
              gameTd.appendChild(span)
              if(parseInt(entry[pick_key]) === winnerId) {
                if(seriesLength == howManyGames) {
                  span.classList.add('correct-games')
                }
                gameTd.classList.add('correct')
              } else {
                gameTd.classList.add('incorrect')
              }
            }
            tr.appendChild(gameTd)
          })

          tbody.appendChild(tr)

          if(!lastUpdated) {
            lastUpdated = updated_at
          } else if (lastUpdated < updated_at) {
            lastUpdated = updated_at
          }

        })

        lastUpdated = new Date(lastUpdated)
        const lastUpdatedNode = document.querySelector('#last-updated')
        lastUpdatedNode.innerHTML = `Päivitetty: ${lastUpdated.toLocaleString()}`
      })
  </script>
</body>
</html>
