<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Koodiklinikan NHL Bracket</title>

  <style>
    table {
      width: 800px;
      border-collapse: collapse;
    }

    thead {
      text-align: left;
    }

    #last-updated {
      margin-top: 1em;
      font-style: italic;
    }

    tbody > tr:nth-child(2n) {
      background: #f5f5f5
    }



    img {
      max-width: 40px;
    }

    td.correct {
      background: green
    }

    td.incorrect {
      background: rgb(106, 3, 3);
    }
  </style>
</head>
<body>
  <h1>Koodiklinikan NHL Bracket Leaderboard 2023</h1>
  <p>Saa parannella: <a href="https://github.com/Hamatti/kk-bracket">hamatti/kk-bracket</a></p>

  <table>
    <thead>
      <tr>
        <th>Sijoitus</th>
        <th>Nimi</th>
        <th>Mestarivalinta</th>
        <th>Pisteitä</th>
        <th>Mahdolliset maksimipisteet</th>
        <th>
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/21.svg">
          -
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/55.svg">
        </th>
        <th>
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/25.svg">
          -
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/30.svg">
        </th>
        <th>
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/54.svg">
          -
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/52.svg">
        </th>
        <th>
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/22.svg">
          -
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/26.svg">
        </th>
        <th>
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/6.svg">
          -
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/13.svg">
        </th>
        <th>
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/10.svg">
          -
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-light/14.svg">
        </th>
        <th>
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/12.svg">
          -
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/2.svg">
        </th>
        <th>
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/1.svg">
          -
          <img src="https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/3.svg">
        </th>
        
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="last-updated"></div>
  
  <script>
    const tbody = document.querySelector('tbody')
    let lastUpdated = null;
    fetch('https://low6-nhl-brackets-prod.azurewebsites.net/leagues/19816/leaderboard?offset=0&limit=17')
      .then(res => res.json())
      .then(async ({entries}) => {
        const series = await fetch('https://low6-nhl-brackets-prod.azurewebsites.net/game').then(res => res.json());
        const games = series.game.series_results;
        console.log(series)

        const firstRound = [101, 102, 103, 104, 105, 106, 107, 108];
        entries.forEach(entry => {
          let tr = document.createElement('tr');
          const {
            rank,
            entry_name,
            points,
            possible_points,
            updated_at,
            champion_id
          } = entry

          let rankTd = document.createElement('td')
          rankTd.innerHTML = rank;
          let nameTd = document.createElement('td')
          nameTd.innerHTML = entry_name;
          let pointsTd = document.createElement('td')
          pointsTd.innerHTML = points;
          let possiblePointsTd = document.createElement('td')
          possiblePointsTd.innerHTML = possible_points;
          let championTd = document.createElement('td')
          let championlogo = document.createElement('img')
          championlogo.src = `https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/${champion_id}.svg`;
          championTd.appendChild(championlogo)

          tr.appendChild(rankTd)
          tr.appendChild(nameTd)
          tr.appendChild(championTd)
          tr.appendChild(pointsTd)
          tr.appendChild(possiblePointsTd)

          firstRound.forEach(gameId => {
            pick_key = `match_${gameId}_pick`;
            let gameTd = document.createElement('td');
            let pickSVG = document.createElement('img')

            const winnerId = games.find(game => game.id === gameId).winner_id
            // Some logos look better with primary light
            if(entry[pick_key] === '14' || entry[pick_key] === '10') {
              pickSVG.src = `https://www-league.nhlstatic.com/images/logos/teams-current-primary-light/${entry[pick_key]}.svg`
            } else {
              pickSVG.src = `https://www-league.nhlstatic.com/images/logos/teams-current-primary-dark/${entry[pick_key]}.svg`
            }
            gameTd.appendChild(pickSVG)

            if(winnerId !== null) {
              console.log({winnerId, pick: entry[pick_key]})
              if(parseInt(entry[pick_key]) === winnerId) {
                gameTd.classList.add('correct')
              } else {
                gameTd.classList.add('incorrect')
              }
            }
            tr.appendChild(gameTd)
          })

          tbody.appendChild(tr)

          if(!lastUpdated) {
            lastUpdated = updated_at
          } else if (lastUpdated < updated_at) {
            lastUpdated = updated_at
          }

        })

        lastUpdated = new Date(lastUpdated)
        const lastUpdatedNode = document.querySelector('#last-updated')
        lastUpdatedNode.innerHTML = `Päivitetty: ${lastUpdated.toLocaleString()}`
      })
  </script>
</body>
</html>